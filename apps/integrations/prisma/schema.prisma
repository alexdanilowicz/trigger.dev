datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  output          = "../node_modules/.prisma/client"
  binaryTargets   = ["native", "debian-openssl-1.1.x"]
  previewFeatures = ["orderByNulls"]
}

model Cache {
  id    String @id @default(cuid())
  namespace String
  key String
  value String
  expiresAt DateTime?
  createdAt DateTime @default(now())

  @@unique([namespace, key])
}

model Webhook {
  id    String @id @default(cuid())
  type WebhookType
  status WebhookStatus
  consumerId String
  key String
  secret String?
  subscriptionType WebhookSubscriptionType
  /// automatic subscriptions responses are stored here
  externalData Json?
  
  //service
  service String?
  webhookName String?
  authenticationData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  destinations Destination[]

  @@unique([consumerId, key])
}

enum WebhookType {
  SERVICE
  GENERIC
}

enum WebhookStatus {
  CREATED
  READY
  CANCELLED
}

enum WebhookSubscriptionType {
  AUTOMATIC
  MANUAL
}

model Destination {
  id    String @id @default(cuid())
  
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  webhookId String

  destinationUrl String @unique
  destinationSecret String
  destinationData Json?
  destinationEvent String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deliveries WebhookEventDelivery[]
}

model WebhookEventDelivery {
  id    String @id @default(cuid())
  eventName String
  
  destination Destination @relation(fields: [destinationId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  destinationId String

  payload Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}